<!DOCTYPE html>
<html class="theme-sleek astro-RDWXBD3Z" lang="en">
  <head>
    <!-- Global Metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="Blogster">
    <meta name="theme-color" content="#ffffff">

<!-- 
  This is an example. 
  Use https://realfavicongenerator.net to generate the icons and manifest. 
-->
<link href="/favicon.ico" rel="shortcut icon">

    <!-- Primary Meta Tags --><title>사용자가 페이지를 떠날 때 안정적으로 HTTP 요청 보내기 (번역)</title>
<meta name="title" content="사용자가 페이지를 떠날 때 안정적으로 HTTP 요청 보내기 (번역)">
<meta name="description" content="description">


<!-- Open Graph / Facebook -->
<meta property="og:title" content="사용자가 페이지를 떠날 때 안정적으로 HTTP 요청 보내기 (번역)">
<meta property="og:description" content="description">
<meta property="og:type" content="article">
<meta property="og:url" content="http://localhost:3000/blog/Browser-send-an-http-request-on-page-exit">
<meta property="article:author" content="연주안">
<meta property="article:published_time" content="2022-01-01T00:00:00.000Z">





<!-- Twitter -->
<meta property="twitter:title" content="사용자가 페이지를 떠날 때 안정적으로 HTTP 요청 보내기 (번역)">
<meta property="twitter:description" content="description">


<meta property="twitter:card" content="summary_large_image">


<!-- {twitter.url && <meta property="twitter:url" content={twitter.url} />} -->

    <!-- 
    We don't want to use <link /> to load fonts from Google CDN 
    but if you want to switch font this is the easiest way 
    to check how your page will look with the new font.
--><!-- 
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;0,700;0,800;1,400;1,700&display=block"
        rel="stylesheet"
    />
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;0,800;1,400&display=swap"
        rel="stylesheet"
    />
--><link rel="preload" href="/fonts/open-sans-v34-latin-regular.woff2" as="font" type="font/woff2" crossorigin="crossorigin"><link rel="preload" href="/fonts/open-sans-v34-latin-700.woff2" as="font" type="font/woff2" crossorigin="crossorigin"><link rel="preload" href="/fonts/open-sans-v34-latin-800.woff2" as="font" type="font/woff2" crossorigin="crossorigin"><link rel="preload" href="/fonts/open-sans-v34-latin-italic.woff2" as="font" type="font/woff2" crossorigin="crossorigin"><style>
    /* open-sans-regular - latin */
    @font-face {
      font-family: "Open Sans";
      font-style: normal;
      font-weight: 400;
      font-display: fallback;
      src: local(""),
        url("/fonts/open-sans-v34-latin-regular.woff2") format("woff2"),
        /* Chrome 26+, Opera 23+, Firefox 39+ */
          url("/fonts/open-sans-v34-latin-regular.woff") format("woff"); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* open-sans-700 - latin */
    @font-face {
      font-family: "Open Sans";
      font-style: normal;
      font-weight: 700;
      font-display: fallback;
      src: local(""),
        url("/fonts/open-sans-v34-latin-700.woff2") format("woff2"),
        /* Chrome 26+, Opera 23+, Firefox 39+ */
          url("/fonts/open-sans-v34-latin-700.woff") format("woff"); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* open-sans-800 - latin */
    @font-face {
      font-family: "Open Sans";
      font-style: normal;
      font-weight: 800;
      font-display: fallback;
      src: local(""),
        url("/fonts/open-sans-v34-latin-800.woff2") format("woff2"),
        /* Chrome 26+, Opera 23+, Firefox 39+ */
          url("/fonts/open-sans-v34-latin-800.woff") format("woff"); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* open-sans-italic - latin */
    @font-face {
      font-family: "Open Sans";
      font-style: italic;
      font-weight: 400;
      font-display: fallback;
      src: local(""),
        url("/fonts/open-sans-v34-latin-italic.woff2") format("woff2"),
        /* Chrome 26+, Opera 23+, Firefox 39+ */
          url("/fonts/open-sans-v34-latin-italic.woff") format("woff"); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
  </style>

    <script>
  // figure out user's preferred theme and set it as html class for tailwind before paint
  (function () {
    if (typeof window !== "undefined") {
      const isSystemColorSchemeDark = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      const storageTheme = sessionStorage.getItem("theme");
      if (!storageTheme && isSystemColorSchemeDark) {
        document.documentElement.classList.add("dark");
        document.head.children.namedItem("theme-color").content = "#0e141b";
      } else if (storageTheme === "dark") {
        document.documentElement.classList.add("dark");
        document.head.children.namedItem("theme-color").content = "#0e141b";
      } else {
        // we already server render light theme
        document.head.children.namedItem("theme-color").content = "#ffffff";
      }
    }
  })();
</script>

    <link href="/fontawesome/css/fontawesome.bareminimum.css" rel="stylesheet"><link href="/fontawesome/css/brands.bareminimum.css" rel="stylesheet"><link href="/fontawesome/css/solid.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/assets/_slug_.eb89f7da.css" />
<link rel="stylesheet" href="/assets/_slug_.43380762.css" /><script type="module" src="/hoisted.fee86805.js"></script></head>

  <body class="min-h-screen max-w-3xl mx-auto px-6 sm:px-8 astro-RDWXBD3Z">
    <header class="astro-ZCCACUUV">
  <a class="unset absolute z-10 left-[50%] -top-[100rem] translate-x-[-50%] bg-white text-black px-8 py-2 focus:top-[initial] astro-ZCCACUUV" href="#main">
    Skip to content
  </a>
  <nav class="astro-ZCCACUUV">
    <section class="text-text-bold astro-ZCCACUUV">
      <ul class="unset flex gap-4 [&>li]:p-0 astro-ZCCACUUV">
        <li class="astro-ZCCACUUV"><!-- DO NOT FORMAT. IT ADDS AN EXTRA SPACE ON RENDERED CONTENT. --><a href="/" class="astro-ZCCACUUV unset animated-link">Home</a></li>
        <li class="astro-ZCCACUUV"><!-- DO NOT FORMAT. IT ADDS AN EXTRA SPACE ON RENDERED CONTENT. --><a href="/blog" class="astro-ZCCACUUV show unset animated-link">Blog</a></li>
      </ul>
    </section>
  </nav>
  <div class="max-[375px]:hidden justify-self-end py-2 flex items-center content-center text-text-bold astro-ZCCACUUV">
    <a class="unset text-xl ml-4 hover:text-text-link astro-ZCCACUUV" href="https://github.com/yeonjuan" target="_blank">
      <i class="fa-brands fa-github astro-ZCCACUUV" aria-hidden="true" title="Blogster on GitHub"></i>
      <span class="fa-sr-only astro-ZCCACUUV">YeonJuAn GitHub</span>
    </a>
  </div>
  <mode-toggle class="flex astro-2DKTDEXU">
  <button class="justify-self-end bg-neutral-200 dark:bg-neutral-700 ml-4 inline-flex h-6 w-11 items-center rounded-full astro-2DKTDEXU" id="mode-toggle" role="switch" type="button" tabindex="0" aria-checked="false" data-headlessui-state=""><span class="sr-only astro-2DKTDEXU">Toggle dark mode</span><span id="mode-circle" class="light inline-block h-4 w-4 rounded-full bg-gradient-to-tr invisible astro-2DKTDEXU"><span class="absolute top-0 right-0 w-[10px] h-[10px] rounded-full bg-gray-700 scale-[0] astro-2DKTDEXU"></span>
  </span>
</button>
</mode-toggle>




</header>

    <main id="main" class="astro-RDWXBD3Z">
      <section class="blog-post prose max-w-none prose-sleek astro-RDWXBD3Z">
        <time class="block mb-[2em] text-text-muted astro-RDWXBD3Z">Jan 1, 2022</time>
        <article><h1 id="http" class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="사용자가 페이지를 떠날 때 안정적으로 HTTP 요청 보내기" href="#http" class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>사용자가 페이지를 떠날 때 안정적으로 HTTP 요청 보내기</span></h1><blockquote><paragraph>이 글은 <a href="https://css-tricks.com/author/alexmacarthur/">Alex AcArthur</a>가 작성한 <a href="https://css-tricks.com/send-an-http-request-on-page-exit/">Reliably Send an HTTP Request as a User Leaves a Page</a>를 번역한 글입니다 (<a href="https://css-tricks.com/translate-an-article/">CSS-Tricks 번역 정책 참고</a>).</paragraph></blockquote><paragraph>사용자가 다른 페이지로 이동하거나 양식을 제출하는 등의 행동을 할 때, 로깅할 데이터가 포함된 HTTP 요청을 전송해야 하는 경우가 여러 번 있었습니다. 링크를 클릭하면 일부 정보를 외부 서비스로 전송하는 예시를 생각해 보세요:</paragraph><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/some-other-page<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>link<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Go to Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">some</span><span class="token operator">:</span> <span class="token string">"data"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
</code></pre>

<paragraph>여기에 크게 복잡한 건 없습니다. 보통 그렇듯이 (<code>e.preventDefault()</code>를 사용하지 않았습니다.) 링크는 정상적으로 동작하도록 했지만, 링크가 동작하기 전, <code>click</code> 시에 <code>POST</code> 요청이 발생합니다. 어떤 종류의 응답도 기다릴 필요가 없습니다. 어떤 결과를 받던지 <strong>단지 전송만</strong> 하기를 원합니다.</paragraph><paragraph>언뜻 보면, 해당 요청의 전송이 동기화된 것처럼 보이고, 그 후 다른 서버가 요청을 성공적으로 처리하는 동안 페이지를 계속 탐색할 것처럼 보입니다. 하지만 밝혀진 바로, 항상 그런 것은 아닙니다.</paragraph><h2 id="http-." class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="브라우저는 열린 HTTP 요청의 보존을 보장하지 않습니다." href="#http-." class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>브라우저는 열린 HTTP 요청의 보존을 보장하지 않습니다.</span></h2><paragraph>무언가 브라우저의 페이지를 종료시킬 때, 진행 중인 HTTP 요청이 성공적으로 처리된다는 보장은 없습니다(<a href="https://developer.chrome.com/blog/page-lifecycle-api/">페이지 생명 주기의 &quot;terminated&quot; 및 다른 상태</a> 참고). 이런 종류의 요청의 신뢰성은 네트워크 연결, 애플리케이션 성능 및 외부 서비스 자체 설정과 같은 몇 가지 요소에 따라 달라질 수 있습니다.</paragraph><paragraph>따라서, 이러한 시점에 데이터를 전송하는 것은 결코 신뢰할 수 없으며, 이런 로그에 의존해 데이터에 민감한 비즈니스 의사결정을 내리게 되면 잠재적으로 큰 문제가 발생할 수 있습니다.</paragraph><paragraph>비신뢰성에 대한 설명을 위해 위 코드를 포함한 페이지가 있는 작은 Express 애플리케이션을 만들었습니다. 링크가 클릭되었을 때 브라우저는 <code>/other</code>로 이동합니다, 하지만 그전에 POST 요청이 발생합니다.</paragraph><paragraph>모든 과정 동안, 저는 브라우저의 네트워크 탭을 열어두고 연결 속도를 &quot;Slow 3g&quot;로 사용했습니다. 페이지를 로드하고 로그를 지웠습니다, 아무런 문제도 없는 것처럼 보입니다:</paragraph><paragraph><image alt="" src="/images/blog/initial-load-1.png"></image></paragraph><paragraph>하지만 링크를 클릭하면 일이 꼬입니다. 페이지 이동이 발생할 때, 요청이 취소됩니다.</paragraph><paragraph><image alt="" src="/images/blog/request-failed-1.webp"></image></paragraph><paragraph>따라서 외부 서비스가 실제로 요청을 처리할 수 있었다는 확신을 할 수 없습니다. 이 동작을 확인하기 위해 <code>window.location</code>을 이용해 프로그래밍적으로 페이지를 이동해도 같은 문제가 발생합니다.</paragraph><pre class="language-js"><code class="language-js">document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 요청이 대기열에 들어갔지만, 페이지 이동이 일어나면서 취소됩니다.</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">some</span><span class="token operator">:</span> <span class="token string">'data'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">+</span> window<span class="token punctuation">.</span>location <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>href<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<paragraph>언제 어떻게 페이지 이동이 발생하고 활성 페이지가 종료되는 지와 관계없이, 이런 완료되지 않은 요청은 취소될 위험이 있습니다.</paragraph><h2 id="" class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="근데 왜 취소될까요?" href="#" class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>근데 왜 취소될까요?</span></h2><paragraph>근본적인 원인은, 기본적으로 XHR 요청(<code>fetch</code> 혹은 <code>XMLHttpRequest</code>에 의한)은 비동기적이고 블로킹이 없다는 것입니다. 요청이 대기열에 들어가자마자, 요청의 실제 <em>작업</em>은 백그라운드에서 브라우저 레벨의 API로 전달됩니다.</paragraph><paragraph>우리는 요청이 메인 스레드를 독차지하는 것을 원하지 않기 때문에 이는 성능 면에서 좋습니다. 하지만 이는 페이지가 &quot;terminated&quot; 상태가 될 때 요청이 버려질 위험이 있다는 것을 뜻하며, 그 어떤 백그라운드 작업도 완료된다는 보장이 없습니다. 여기 <a href="https://developer.chrome.com/blog/page-lifecycle-api/#states">Google 이 라이프 사이클 상태</a>에 대해 어떻게 요약했는지 보겠습니다:</paragraph><blockquote><paragraph>브라우저 메모리에서 내려가고 지워지기 시작하면 페이지는 terminated 상태가 됩니다. 이 상태에서는 <a href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task">새로운 작업</a>이 시작되지 않으며, 진행 중인 작업이 너무 오래 실행될 경우 중지될 수 있습니다.</paragraph></blockquote><paragraph>간단히 말해서, 브라우저는 페이지가 삭제될 때, 페이지에 의해 대기 중인 백그라운드 프로세스를 계속 처리할 필요가 없다는 가정 하에 설계되었습니다.</paragraph><h2 id="" class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="그래서, 우리가 선택할 수 있는 건 무엇일까요?" href="#" class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>그래서, 우리가 선택할 수 있는 건 무엇일까요?</span></h2><paragraph>아마 이 문제를 피하기 위한 가장 명확한 접근 방법은 요청이 응답을 반환할 때까지 사용자 작업을 지연시키는 것입니다. 예전에는, <code>XMLHttpRequest</code>에서 지원하는 <a href="https://xhr.spec.whatwg.org/#synchronous-flag">synchronous 플래그</a>를 사용하는 잘못된 방식으로 하곤 했습니다. 하지만 이를 사용하면 메인 스레드를 완전히 차단시키고, 여러 성능 문제가 발생합니다 - 저는 이런 문제에 대한 <a href="https://macarthur.me/posts/use-web-workers-for-your-event-listeners">글</a>을 작성했었습니다 - 그래서 이 방식은 고려할 필요도 없습니다. 사실, 이 기능은 플랫폼에서 제거되고 있습니다 (<a href="https://developer.chrome.com/blog/chrome-80-deps-rems/">Chrome v80+에서는 이미 제거되었습니다.</a>)</paragraph><paragraph>대신, 이런 접근 방식을 사용할 경우 응답이 반환되어 <code>Promise</code> 가 resolve 될 때까지 기다리는 것이 좋습니다. 다시 돌아온 후에는 안전하게 동작을 수행할 수 있습니다. 앞선 예제를 사용하면, 아래처럼 할 수 있습니다.</paragraph><pre class="language-js"><code class="language-js">document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 응답이 돌아오기를 기다리고...</span>
  <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">some</span><span class="token operator">:</span> <span class="token string">'data'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...나서 페이지를 이동한다.</span>
   window<span class="token punctuation">.</span>location <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>href<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<paragraph>이러면 작업을 완료할 수 있지만, 몇 가지 사소하지 않은 단점이 있습니다.</paragraph><paragraph><strong>첫째, 원하는 동작이 발생하지 않도록 지연시킴으로써 사용자 경험을 손상시킵니다.</strong> 분석 데이터를 수집하는 것은 확실히 비즈니스(그리고 잠재적 사용자들)에게 이익이 되지만, <em>현재</em> 사용자가 그 이익을 위해 비용을 지불하도록 하는 것은 이상적이지 않습니다. 말할 것도 없이, 외부 종속성에 의해, 그 서비스 자체가 가진 어떠한 지연이나 성능 문제가 사용자에게 보여지게 됩니다. 분석 서비스에서 타임아웃이 발생해서 고객이 중요한 작업을 하지 못하면 모든 사람이 손해를 보게 됩니다.</paragraph><paragraph><strong>둘째, 몇몇 종료 동작은 프로그래밍 방식으로 지연시킬 수 없기 때문에 이런 접근은 앞에서 들었던 것처럼 신뢰할 수 없습니다.</strong> 예를 들어 <code>e.preventDefault()</code>는 브라우저 탭을 닫는 것을 지연시킬 때는 효과가 없습니다. 그래서 기껏해야, <em>일부</em> 사용자 작업에 대한 데이터 수집은 커버할 수 있지만 종합적으로 신뢰할 수 있을 정도는 아닙니다.</paragraph><h2 id="" class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="브라우저에 미처리 요청을 보존하도록 지시하기" href="#" class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>브라우저에 미처리 요청을 보존하도록 지시하기</span></h2><paragraph>다행히, 미처리 HTTP 요청을 <em>보존</em>할 수 있는 옵션이 있고, 이는 대부분의 브라우저에 내장되어 있으며 사용자 경험을 손상시키지 않습니다.</paragraph><h3 id="fetch" class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="Fetch 의 " href="#fetch" class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>Fetch 의 [object Object] 플래그 사용하기</span></h3><paragraph><code>fetch()</code>를 사용할 때 <a href="https://fetch.spec.whatwg.org/#request-keepalive-flag">keepalive</a> 플래그가 <code>true</code>로 설정되어 있으면, 해당 요청을 시작한 페이지가 종료되더라도 해당 요청이 열린 상태로 유지됩니다. 처음 예제를 사용하면 다음과 같이 구현할 수 있습니다.</paragraph><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/some-other-page<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>link<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Go to Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> 
      <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">some</span><span class="token operator">:</span> <span class="token string">"data"</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
      <span class="token literal-property property">keepalive</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
</code></pre>

<paragraph>해당 링크를 클릭하고 페이지 이동이 발생해도, 요청 취소가 발생하지 않습니다:</paragraph><paragraph><image alt="" src="/images/blog/request-priorities.webp"></image></paragraph><paragraph>대신, <code>(unknown)</code> 상태가 남게 되는데, 단순히 활성 페이지가 어떤 종료의 응답도 기다리지 않기 때문입니다.</paragraph><paragraph>특히, 일반적으로 사용되는 브라우저 API의 일부인 경우 이와 같이 한 줄이면 쉽게 해결할 수 있습니다. 그러나 더 단순한 인터페이스를 가진 더 집중적인 옵션을 찾고 있다면, 브라우저 지원을 받는 다른 방법도 있습니다.</paragraph><h3 id="" class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="" href="#" class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>[object Object] 사용하기</span></h3><paragraph><code>Navigator.sendBeacon()</code> 함수는 단방향 요청을 전송하기 위해 특별히 고안되었습니다 (<a href="https://w3c.github.io/beacon/#sec-processing-model">beacons</a>). 기본 구현은 다음과 같습니다. 직렬화된 <code>JSON</code> 과 “text/plain” <code>Content-Type</code> 을 포함한 <code>POST</code> 요청을 전송합니다:</paragraph><pre class="language-js"><code class="language-js">navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">'/log'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">some</span><span class="token operator">:</span> <span class="token string">"data"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<paragraph>하지만, 이 API는 커스텀 헤더를 보내도록 허용하지 않습니다. 그래서, 데이터를 “application/json” 로 전송하려면 <code>Blob</code>을 사용해 약간 수정해서 사용해야 합니다:</paragraph><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/some-other-page<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>link<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Go to Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">some</span><span class="token operator">:</span> <span class="token string">"data"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'application/json; charset=UTF-8'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">'/log'</span><span class="token punctuation">,</span> blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
</code></pre>

<paragraph>결국, 동일한 결과를 얻을 수 있습니다 - 페이지 이동 후에도 요청을 완료할 수 있습니다. 하지만 <code>fetch()</code> 보다 나은 점이 있습니다: 비콘은 낮은 우선순위로 전송됩니다.</paragraph><paragraph>설명을 위해, 여기 <code>keepalive</code> 가 있는 <code>fetch()</code>와 <code>sendBeacon()</code>이 동시에 사용될 때 네트워크 탭에 표시되는 것입니다:</paragraph><paragraph><image alt="" src="/images/blog/request-priorities.webp"></image></paragraph><paragraph>기본적으로, <code>fetch()</code>는 “High” 우선 순위를 받는 반면, 비콘은(위에서 “ping” 유형으로 표시됨)은 “Lowest” 우선 순위를 가집니다. 페이지 기능에 중요하지 않은 요청의 경우 이 방법은 좋습니다. <a href="https://www.w3.org/TR/beacon/">Beacon 스펙</a>에서 발췌한 내용입니다:</paragraph><blockquote><paragraph>이 스펙은 다음 인터페이스를 정의합니다 […] 시간적으로 중요한 다른 작업과 리소스 경합을 최소화하면서 요청이 계속 처리되고 대상으로 전달되도록 보장합니다.</paragraph></blockquote><paragraph>다른 말로하면, <code>sendBeacon()</code> 은 그 요청이 애플리케이션에 중요한 것들과 사용자 경험에 관여하지 않도록 합니다.</paragraph><h2 id="" class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="" href="#" class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>[object Object] 속성에 대한 훌륭한 언급</span></h2><paragraph>점점 더 많은 브라우저들이 <a href="https://css-tricks.com/the-ping-attribute-on-anchor-links/">ping 속성</a>을 지원한다는 것을 언급할 가치가 있습니다. 링크에 사용되면 이는 작은 <code>POST</code> 요청을 전송합니다.</paragraph><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:3000/other<span class="token punctuation">"</span></span> <span class="token attr-name">ping</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:3000/log<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  Go to Other Page
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
</code></pre>

<paragraph>이 요청 헤더에는 링크가 클릭된 페이지(<code>ping-from</code>)와 해당 링크의 <code>href</code> 값(<code>ping-to</code>)이 포함됩니다:</paragraph><pre class="language-js"><code class="language-js"><span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'ping-from'</span><span class="token operator">:</span> <span class="token string">'http://localhost:3000/'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'ping-to'</span><span class="token operator">:</span> <span class="token string">'http://localhost:3000/other'</span>
  <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/ping'</span>
  <span class="token comment">// ...다른 헤더들</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>

<paragraph>이는 비콘 전송과 기술적으로 유사하지만, 주목할 만한 제한사항이 있습니다.</paragraph><ol><li><paragraph><strong>링크에서만 사용할 수 있도록 엄격하게 제한되므로</strong>, 버튼클릭이나 양식 제출과 같은 다른 상호작용과 관련된 데이터를 추적해야 하는 경우 사용할 수 없습니다.</paragraph></li><li><paragraph><strong>브라우저 지원이 나쁘지는 않지만, <a href="https://caniuse.com/ping">아주 좋지는 않습니다</a></strong>. 글을 작성하는 현재, Firefox는 기본적으로 이를 사용하지 않도록 설정되어 있습니다.</paragraph></li><li><paragraph><strong>요청과 함께 커스텀 데이터를 보낼수 없습니다.</strong> 언급한 바와 같이 몇가지 ping-* 헤더와 몇가지 다른 헤더를 같이 얻을 수 있습니다.</paragraph></li></ol><paragraph>모든 것을 고려해 볼 때, <code>ping</code> 은 간단한 요청으로 충분하고 커스텀 JavaScript 를 작성하지 않으려는 경우 좋은 방법입니다. 하지만 더 중요한 것을 보내야한다면, 가장 좋은 방법은 아닐 수 있습니다.</paragraph><h2 id="" class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="그래서 어떤것을 사용해야 할까요?" href="#" class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>그래서 어떤것을 사용해야 할까요?</span></h2><paragraph><code>keepalive</code>와 함께 <code>fetch</code>를 사용하거나 <code>sendBeacon()</code>을 사용하여 마지막 요청을 전송하는 것에는 분명한 트레이드오프가 있습니다. 다양한 상황에 가장 적합한 항목을 식별하기 위해 고려해야 할 몇 가지 사항은 다음과 같습니다:</paragraph><h3 id="" class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="아래와 같은 경우에는 " href="#" class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>아래와 같은 경우에는 [object Object] + [object Object] 를 사용하는 것이 좋습니다.</span></h3><ul><li>요청과 함께 커스텀 헤더를 쉽게 전달해야 합니다.</li><li>서비스에 <code>POST</code> 가 아닌 <code>GET</code> 요청을 하려고 합니다.</li><li>예전 브라우저(IE 같은)를 지원하고 있으며 이미 <code>fetch</code> 폴리필이 로드되어 있습니다.</li></ul><h3 id="" class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="하지만 아래의 경우에는 " href="#" class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>하지만 아래의 경우에는 [object Object]이 더 좋은 선택일 수 있습니다.</span></h3><ul><li>커스텀이 많이 필요하지 않은 간단한 서비스 요청을 하고 있습니다.</li><li>깔끔하고 우아한 API 를 선호합니다.</li><li>요청이 애플리케이션에서 발송되는 다른 높은 우선순위의 요청과 경쟁하지 않도록 보장하려 합니다</li></ul><h2 id="" class="group flex -ml-[1rem]"><span class="not-prose w-[1rem] -mt-[0.125rem]">
        <a aria-label="link to this heading" aria-describedby="제 실수를 반복하지 마세요" href="#" class="unset align-middle text-[14px] text-text-link opacity-0 group-hover:opacity-100 group-focus:opacity-100 focus:opacity-100 group-active:opacity-100 active:opacity-100">
            <i class="fa-solid fa-hashtag"></i>
        </a>
    </span><span>제 실수를 반복하지 마세요</span></h2><paragraph>페이지가 종료될 때 브라우저가 처리 중인 요청을 다루는 방식에 대해서 자세히 알아보기로 한 이유가 있습니다. 얼마 전, 우리 팀은 양식을 제출할 때 요청을 실행하기 시작한 후 갑자기 특정 유형의 분석 로그 빈도가 변하는 것을 보았습니다. 이 변화는 갑작스러웠고 중요했습니다 - 과거에 보았던 것보다 약 ~30% 감소했습니다.</paragraph><paragraph>이 문제가 발생한 이유와 이를 피할 수 있는 도구를 파헤쳐 곤경을 면할 수 있었습니다. 그래서, 저는 이런 도전들의 뉘앙스를 이해하는 것이 누군가 우리가 마주친 고통의 일부를 피하는데 도움이 되기를 바랍니다. Happy logging!</paragraph></article>
      </section>
    </main>
    <footer class="text-sm leading-[1.75] mt-4 astro-IKVAUYX3">
  <div class="astro-IKVAUYX3">
    This blog is built with
    <a class="unset gradient-link tracking-wider font-bold bg-clip-text text-transparent bg-gradient-to-r from-[#f57111] to-[#f79605] hover:after:bg-gradient-to-r hover:after:from-[#f57111] hover:after:to-[#f79605] astro-IKVAUYX3" href="https://github.com/flexdinesh/blogster" target="_blank">
      Blogster</a>
  </div>
</footer>


    
  </body>
</html>